

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fluxfootprints.improved_ffp &mdash; fluxfootprint 0.1.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=92734c54"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            fluxfootprint
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fluxfootprints.html">fluxfootprints package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">fluxfootprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp.html">FluxÂ Footprints: Key Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modeltypes.html">Outline of Flux Measurement Footprint Estimation Approaches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/footprint.html">Quick-start notebook</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fluxfootprint</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fluxfootprints.improved_ffp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fluxfootprints.improved_ffp</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Improved Flux Footprint Prediction (FFP) Module</span>

<span class="sd">This module implements the FFP model described in:</span>
<span class="sd">Kljun, N., P. Calanca, M.W. Rotach, H.P. Schmid, 2015:</span>
<span class="sd">A simple two-dimensional parameterisation for Flux Footprint Prediction (FFP).</span>
<span class="sd">Geosci. Model Dev. 8, 3695-3713, doi:10.5194/gmd-8-3695-2015</span>

<span class="sd">This version includes improvements for better alignment with the theoretical framework.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>


<div class="viewcode-block" id="FFPModel">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FFPModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flux Footprint Prediction (FFP) model based on Kljun et al. (2015).</span>

<span class="sd">    This class implements an improved version of the flux footprint model</span>
<span class="sd">    for determining the source area of scalar fluxes measured by</span>
<span class="sd">    eddy covariance towers. It uses atmospheric stability, wind parameters,</span>
<span class="sd">    and terrain configurations to calculate spatial footprints.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    REQUIRED_COLUMNS : list of str</span>
<span class="sd">        Names of required columns in the input DataFrame.</span>

<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Copy of the input DataFrame used for modeling.</span>

<span class="sd">    domain : list of float</span>
<span class="sd">        Spatial domain defined as [xmin, xmax, ymin, ymax].</span>

<span class="sd">    fclim_2d : xarray.DataArray or None</span>
<span class="sd">        Final footprint climatology after all processing.</span>

<span class="sd">    f_2d : xarray.DataArray or None</span>
<span class="sd">        Instantaneous 2D footprint estimate.</span>

<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Logger instance for model-level debugging.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REQUIRED_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;sigmav&quot;</span><span class="p">,</span>  <span class="c1"># Standard deviation of lateral velocity fluctuations</span>
        <span class="s2">&quot;ustar&quot;</span><span class="p">,</span>  <span class="c1"># Friction velocity</span>
        <span class="s2">&quot;ol&quot;</span><span class="p">,</span>  <span class="c1"># Obukhov length</span>
        <span class="s2">&quot;wind_dir&quot;</span><span class="p">,</span>  <span class="c1"># Wind direction</span>
        <span class="s2">&quot;umean&quot;</span><span class="p">,</span>  <span class="c1"># Wind speed</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">domain</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1000.0</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">],</span>
        <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">dy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">rs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
        <span class="n">crop_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">atm_bound_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2000.0</span><span class="p">,</span>
        <span class="n">inst_height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">rslayer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">smooth_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">crop</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the FFP model with input data and configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            Input DataFrame with required meteorological columns including:</span>
<span class="sd">            &#39;V_SIGMA&#39;, &#39;USTAR&#39;, &#39;MO_LENGTH&#39;, &#39;WD&#39;, &#39;WS&#39;.</span>

<span class="sd">        domain : list of float, optional</span>
<span class="sd">            Footprint domain in the format [xmin, xmax, ymin, ymax].</span>

<span class="sd">        dx : float, optional</span>
<span class="sd">            Grid spacing in the x-direction (meters). Default is 10.0.</span>

<span class="sd">        dy : float, optional</span>
<span class="sd">            Grid spacing in the y-direction (meters). Default is 10.0.</span>

<span class="sd">        nx : int, optional</span>
<span class="sd">            Number of grid points in the x-direction. Default is 1000.</span>

<span class="sd">        ny : int, optional</span>
<span class="sd">            Number of grid points in the y-direction. Default is 1000.</span>

<span class="sd">        rs : list of float, optional</span>
<span class="sd">            Relative source area contributions to evaluate. Values must be between 0 and 1.</span>

<span class="sd">        crop_height : float, optional</span>
<span class="sd">            Height of vegetation or surface roughness (m). Default is 0.2.</span>

<span class="sd">        atm_bound_height : float, optional</span>
<span class="sd">            Height of the atmospheric boundary layer (m). Must be &gt; 10. Default is 2000.0.</span>

<span class="sd">        inst_height : float, optional</span>
<span class="sd">            Height of the measurement instrument (m). Must be &gt; crop_height. Default is 2.0.</span>

<span class="sd">        rslayer : bool, optional</span>
<span class="sd">            If True, apply roughness sublayer corrections. Default is False.</span>

<span class="sd">        smooth_data : bool, optional</span>
<span class="sd">            Whether to apply smoothing to the footprint climatology. Default is True.</span>

<span class="sd">        crop : bool, optional</span>
<span class="sd">            If True, crop output to significant areas. Default is False.</span>

<span class="sd">        verbosity : int, optional</span>
<span class="sd">            Verbosity level for logging (0=none, 1=info, 2=debug). Default is 2.</span>

<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Custom logger. If None, a new logger is created.</span>

<span class="sd">        kwargs : dict</span>
<span class="sd">            Additional keyword arguments for future extensions.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any input parameters are invalid or inconsistent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span>

        <span class="c1"># Set up logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="c1"># Model constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># von Karman constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oln</span> <span class="o">=</span> <span class="mf">5000.0</span>  <span class="c1"># neutral stability limit</span>

        <span class="c1"># Add RSL-specific parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_rsl</span> <span class="o">=</span> <span class="mf">2.75</span>  <span class="c1"># RSL height multiplier (2 â¤ n â¤ 5 per paper)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsl_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;conv&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ps1&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>  <span class="c1"># p value for convective conditions</span>
            <span class="s2">&quot;stab&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ps1&quot;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">},</span>  <span class="c1"># p value for stable conditions</span>
        <span class="p">}</span>

        <span class="c1"># Validate input DataFrame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Process input data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep_df_fields</span><span class="p">(</span>
            <span class="n">crop_height</span><span class="o">=</span><span class="n">crop_height</span><span class="p">,</span>
            <span class="n">inst_height</span><span class="o">=</span><span class="n">inst_height</span><span class="p">,</span>
            <span class="n">atm_bound_height</span><span class="o">=</span><span class="n">atm_bound_height</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Initialize basic attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_y_correction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_domain</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_rs</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>

        <span class="c1"># Validate physical parameters</span>
        <span class="k">if</span> <span class="n">crop_height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;crop_height must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">atm_bound_height</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atm_bound_height must be &gt; 10m&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inst_height</span> <span class="o">&lt;=</span> <span class="n">crop_height</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;inst_height must be greater than crop_height&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crop_height</span> <span class="o">=</span> <span class="n">crop_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atm_bound_height</span> <span class="o">=</span> <span class="n">atm_bound_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst_height</span> <span class="o">=</span> <span class="n">inst_height</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_data</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">smooth_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">crop</span><span class="p">)</span>

        <span class="c1"># Initialize model parameters (will be updated based on stability)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model_parameters</span><span class="p">()</span>

        <span class="c1"># Set up computational domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_domain</span><span class="p">()</span>

        <span class="c1"># Create xarray dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_xr_dataset</span><span class="p">()</span>

        <span class="c1"># Perform validity checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_validity_ranges</span><span class="p">()</span>

        <span class="c1"># Handle stability regimes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_stability_regimes</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_input_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that the input DataFrame contains all required columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            The input DataFrame to validate.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If required columns are missing from the DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy to avoid modifying original</span>

        <span class="c1"># Rename fields to standard names</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;V_SIGMA&quot;</span><span class="p">:</span> <span class="s2">&quot;sigmav&quot;</span><span class="p">,</span>
                <span class="s2">&quot;USTAR&quot;</span><span class="p">:</span> <span class="s2">&quot;ustar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;wd&quot;</span><span class="p">:</span> <span class="s2">&quot;wind_dir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;WD&quot;</span><span class="p">:</span> <span class="s2">&quot;wind_dir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MO_LENGTH&quot;</span><span class="p">:</span> <span class="s2">&quot;ol&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ws&quot;</span><span class="p">:</span> <span class="s2">&quot;umean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;WS&quot;</span><span class="p">:</span> <span class="s2">&quot;umean&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_COLUMNS</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing required columns in input DataFrame: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for invalid values</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_COLUMNS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df1</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found null values in column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found non-finite values in column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the domain boundaries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        domain : list of float</span>
<span class="sd">            A list with exactly four elements: [xmin, xmax, ymin, ymax].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of float</span>
<span class="sd">            Validated domain list.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the domain is not in the correct format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;domain must be a list of [xmin, xmax, ymin, ymax]&quot;</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">domain</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid domain bounds&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">domain</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_rs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rs</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the list of relative source area contributions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rs : list of float</span>
<span class="sd">            List of values between 0 and 1 (exclusive).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of float</span>
<span class="sd">            Sorted list of validated relative contributions.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any value in the list is not in the (0, 1) range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rs must be a list or array&quot;</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;all rs values must be between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up a logger for the FFPModel class.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        logging.Logger</span>
<span class="sd">            A configured logger instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;FFPModel&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>

<div class="viewcode-block" id="FFPModel.get_scalar_value">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.get_scalar_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scalar_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an array-like object to a scalar float value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arr : array-like or scalar</span>
<span class="sd">            The value to be converted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            A scalar representation of the input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.calc_crosswind_integrated_footprint">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_crosswind_integrated_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_crosswind_integrated_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_star</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the scaled crosswind-integrated footprint FÌy*(XÌ*).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_star : xarray.DataArray</span>
<span class="sd">            Scaled distance from the receptor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            The scaled crosswind-integrated footprint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating crosswind-integrated footprint...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get scalar parameters</span>
            <span class="n">a_scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="n">b_scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="n">c_scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="n">d_scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>

            <span class="c1"># Calculate modified x_star</span>
            <span class="n">x_star_modified</span> <span class="o">=</span> <span class="n">x_star</span> <span class="o">-</span> <span class="n">d_scalar</span>

            <span class="c1"># Create mask for valid values</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">x_star_modified</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="c1"># Calculate footprint using xarray&#39;s where operation</span>
            <span class="n">f_star</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">mask</span><span class="p">,</span>
                <span class="n">a_scalar</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">x_star_modified</span><span class="o">**</span><span class="n">b_scalar</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c_scalar</span> <span class="o">/</span> <span class="n">x_star_modified</span><span class="p">),</span>
                <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Log statistics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x_star_modified shape: </span><span class="si">{</span><span class="n">x_star_modified</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;x_star_modified range: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x_star_modified</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x_star_modified</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;f_star shape: </span><span class="si">{</span><span class="n">f_star</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;f_star range: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">f_star</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">f_star</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">f_star</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in crosswind integration: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FFPModel.get_source_area_contour">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.get_source_area_contour">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_source_area_contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">x_ru</span><span class="p">,</span> <span class="n">x_rd</span><span class="p">,</span> <span class="n">y_r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a contour dataset for a given source area.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : float</span>
<span class="sd">            Relative contribution (0 &lt; r &lt; 1).</span>
<span class="sd">        x_ru : float</span>
<span class="sd">            Upwind distance.</span>
<span class="sd">        x_rd : float</span>
<span class="sd">            Downwind distance.</span>
<span class="sd">        y_r : float</span>
<span class="sd">            Crosswind extent.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>
<span class="sd">            Contour dataset with coordinates and footprint values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get scalar values</span>
        <span class="n">x_rd_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="n">x_rd</span><span class="p">)</span>
        <span class="n">x_ru_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="n">x_ru</span><span class="p">)</span>
        <span class="n">y_r_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="n">y_r</span><span class="p">)</span>

        <span class="c1"># Create distance arrays with unique, evenly spaced coordinates</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_rd_val</span><span class="p">,</span> <span class="n">x_ru_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">y_r_val</span><span class="p">,</span> <span class="n">y_r_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>

        <span class="c1"># Ensure coordinates are unique by adding small offset where needed</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>  <span class="c1"># Smallest possible float value</span>
        <span class="n">x_unique</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">eps</span>
        <span class="n">y_unique</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">*</span> <span class="n">eps</span>

        <span class="c1"># Create grid</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_unique</span><span class="p">,</span> <span class="n">y_unique</span><span class="p">)</span>

        <span class="c1"># Calculate polar coordinates</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">)</span>

        <span class="c1"># Get mean wind direction</span>
        <span class="n">wind_dir_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">])</span>
        <span class="n">rotated_theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">-</span> <span class="p">(</span><span class="n">wind_dir_mean</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span>

        <span class="c1"># Calculate footprint components using mean values</span>
        <span class="n">x_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_scaled_x</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">sigma_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_spread</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">f_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_integrated_footprint</span><span class="p">(</span><span class="n">x_star</span><span class="p">)</span>

        <span class="c1"># Calculate 2D footprint</span>
        <span class="n">f_2d</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_y</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Calculate contour level</span>
        <span class="n">total_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_2d</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="n">sorted_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">f_2d</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cumsum_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sorted_f</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumsum_f</span> <span class="o">/</span> <span class="n">total_flux</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_f</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">contour_level</span> <span class="o">=</span> <span class="n">sorted_f</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Create output dataset with unique coordinates</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;contour_level&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">contour_level</span><span class="p">),</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">x_unique</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">y_unique</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">f_2d</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.calc_scaled_x">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_scaled_x">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_scaled_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the scaled distance X* based on wind and height parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float or ndarray</span>
<span class="sd">            Upwind distance from the receptor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or ndarray</span>
<span class="sd">            Scaled distance X*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get mean values</span>
        <span class="n">zm_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">h_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">u_zm_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;umean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ustar_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="c1"># Calculate scaling</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">x</span> <span class="o">/</span> <span class="n">zm_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">zm_mean</span> <span class="o">/</span> <span class="n">h_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ustar_mean</span> <span class="o">/</span> <span class="p">(</span><span class="n">u_zm_mean</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="FFPModel.initialize_model_parameters">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.initialize_model_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_model_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize core model parameters (a, b, c, d, ac, bc, cc).</span>
<span class="sd">        Ensures scalar values are assigned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert all parameters to scalar values</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">ensure_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scalar_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Base parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="mf">1.4524</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="o">-</span><span class="mf">1.9914</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="mf">1.4622</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="mf">0.1359</span><span class="p">)</span>

        <span class="c1"># Crosswind dispersion parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="mf">2.17</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="mf">1.66</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">ensure_scalar</span><span class="p">(</span><span class="mf">20.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.check_rsl_validity">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.check_rsl_validity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_rsl_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the measurement height is above the roughness sublayer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.Series</span>
<span class="sd">            Boolean mask of valid rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate RSL height</span>
        <span class="n">h_rs</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">]</span>  <span class="c1"># Roughness element height</span>
        <span class="n">z_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rsl</span> <span class="o">*</span> <span class="n">h_rs</span>  <span class="c1"># RSL height</span>

        <span class="c1"># Check if measurement height is above RSL</span>
        <span class="n">rsl_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">z_star</span>

        <span class="c1"># Log RSL check results</span>
        <span class="n">invalid_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">rsl_valid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invalid_count</span><span class="si">}</span><span class="s2"> measurements within roughness sublayer &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(zm &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rsl</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> * h_rs)&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">rsl_valid</span></div>


<div class="viewcode-block" id="FFPModel.apply_rsl_corrections">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.apply_rsl_corrections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_rsl_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply roughness sublayer (RSL) corrections to crosswind dispersion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate RSL parameters</span>
        <span class="n">h_rs</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">]</span>
        <span class="n">z_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rsl</span> <span class="o">*</span> <span class="n">h_rs</span>

        <span class="c1"># Identify measurements within RSL</span>
        <span class="n">in_rsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_star</span>

        <span class="k">if</span> <span class="n">in_rsl</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Calculate scaling factors for RSL effects</span>
            <span class="n">stability_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span>

            <span class="c1"># Get appropriate ps1 value based on stability</span>
            <span class="n">ps1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">stability_param</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rsl_params</span><span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">][</span><span class="s2">&quot;ps1&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rsl_params</span><span class="p">[</span><span class="s2">&quot;stab&quot;</span><span class="p">][</span><span class="s2">&quot;ps1&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Calculate RSL correction based on eq. C1-C3</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">ps1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span>
            <span class="n">sigma_y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span>

            <span class="c1"># First calculate the basic crosswind spread</span>
            <span class="n">sigma_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="p">)</span>

            <span class="c1"># Then combine with near-source dispersion term where needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_y</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_rsl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_y0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">sigma_y</span><span class="p">)</span>

            <span class="c1"># Calculate blind zone correction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span>

            <span class="c1"># Log RSL corrections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Applied RSL corrections to </span><span class="si">{</span><span class="n">in_rsl</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2"> measurements&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.prep_df_fields">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.prep_df_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_df_fields</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">crop_height</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">inst_height</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">atm_bound_height</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare and normalize input DataFrame fields for footprint calculation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        crop_height : float</span>
<span class="sd">            Vegetation height.</span>
<span class="sd">        inst_height : float</span>
<span class="sd">            Instrument height.</span>
<span class="sd">        atm_bound_height : float</span>
<span class="sd">            Atmospheric boundary layer height.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate displacement height</span>
        <span class="n">d_h</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.979</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">crop_height</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.154</span><span class="p">)</span>

        <span class="c1"># Add derived fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_height</span> <span class="o">-</span> <span class="n">d_h</span>  <span class="c1"># measurement height above displacement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h_c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_height</span> <span class="o">*</span> <span class="mf">0.123</span>  <span class="c1"># roughness length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm_bound_height</span>

        <span class="c1"># Apply validity checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_validity_masks</span><span class="p">()</span>

        <span class="c1"># Drop invalid data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">,</span> <span class="s2">&quot;wind_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;ol&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid input length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add RSL validity check</span>
        <span class="n">rsl_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_rsl_validity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rsl_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsl_valid</span>

        <span class="c1"># Additional RSL parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h_rs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;z_star&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rsl</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h_rs&quot;</span><span class="p">]</span>

        <span class="c1"># Log RSL statistics</span>
        <span class="n">mean_z_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;z_star&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mean RSL height (z*): </span><span class="si">{</span><span class="n">mean_z_star</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">m, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Measurement height: </span><span class="si">{</span><span class="n">inst_height</span><span class="si">}</span><span class="s2">m&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_validity_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply basic physical constraints to filter invalid data in the DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">],</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FFPModel.define_domain">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.define_domain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the spatial computational domain and polar coordinate grids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting up computational domain...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create coordinate arrays</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain dimensions - x: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">, y: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create 2D grid with explicit dimensions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

            <span class="c1"># Create polar coordinate grids as xarray DataArrays with explicit dimensions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">yv</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># Initialize footprint grid with proper dimensions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Grid shapes - xv: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, rho: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Domain setup completed successfully&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in domain setup: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FFPModel.create_xr_dataset">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.create_xr_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_xr_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create xarray Dataset from input DataFrame.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.handle_stability_regimes">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.handle_stability_regimes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_stability_regimes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify stability regimes and assign model parameters based on regime.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.Dataset</span>
<span class="sd">            Dataset with regime-specific masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate stability parameter zm/L</span>
        <span class="n">stability_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span>

        <span class="c1"># Define regime boundaries per paper</span>
        <span class="n">regimes</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>

        <span class="c1"># Convective regimes</span>
        <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;strongly_unstable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stability_param</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">15.5</span>
        <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;unstable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stability_param</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">15.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stability_param</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Near-neutral regime</span>
        <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;neutral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stability_param</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stability_param</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Stable regimes</span>
        <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;stable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stability_param</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">stability_param</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">oln</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;strongly_stable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stability_param</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oln</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate regime-specific parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;unstable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mf">2.930</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.285</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mf">2.127</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.107</span><span class="p">},</span>
            <span class="s2">&quot;neutral&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mf">1.472</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.996</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mf">1.480</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.169</span><span class="p">},</span>
            <span class="s2">&quot;stable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mf">1.472</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.996</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mf">1.480</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mf">0.169</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Implement smooth transitions between regimes</span>
        <span class="n">transition_zone</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">transition_weight</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Calculate smooth transition weight.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">((</span><span class="n">param</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span><span class="p">))</span>

        <span class="c1"># Calculate regime weights</span>
        <span class="n">neutral_to_unstable</span> <span class="o">=</span> <span class="n">transition_weight</span><span class="p">(</span><span class="n">stability_param</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">transition_zone</span><span class="p">)</span>
        <span class="n">neutral_to_stable</span> <span class="o">=</span> <span class="n">transition_weight</span><span class="p">(</span><span class="n">stability_param</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">transition_zone</span><span class="p">)</span>

        <span class="c1"># Apply smooth parameter transitions</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">neutral_to_unstable</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;unstable&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">neutral_to_unstable</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">neutral_to_stable</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;neutral&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">neutral_to_stable</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;stable&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Log regime statistics</span>
        <span class="k">for</span> <span class="n">regime</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">regimes</span><span class="p">[</span><span class="n">regime</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_len</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">regime</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> points (</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

        <span class="c1"># Add stability flags to output dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;stability_regime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;strongly_unstable&quot;</span><span class="p">],</span>
            <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;unstable&quot;</span><span class="p">],</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;neutral&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">regimes</span><span class="p">[</span><span class="s2">&quot;stable&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">regimes</span></div>


<div class="viewcode-block" id="FFPModel.check_validity_ranges">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.check_validity_ranges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_validity_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check validity ranges according to equation 27 and other constraints from Kljun et al. (2015).</span>

<span class="sd">        Implements the following validity checks:</span>
<span class="sd">        1. Height validity (Eq. 27): 20zâ &lt; zm &lt; he</span>
<span class="sd">           where he â 0.8h is the entrainment height</span>
<span class="sd">        2. Stability validity (Eq. 27): -15.5 â¤ zm/L</span>
<span class="sd">        3. Turbulence validity: u* &gt; 0.1 m/s, Ïv &gt; 0</span>
<span class="sd">        4. Roughness sublayer validity: zm &gt; z* â n*hrs</span>
<span class="sd">           where hrs â 10zâ and 2 â¤ n â¤ 5 (Section 2)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset: Dataset containing boolean masks for:</span>
<span class="sd">        - height_valid: True where 20zâ &lt; zm &lt; he</span>
<span class="sd">        - stability_valid: True where -15.5 â¤ zm/L</span>
<span class="sd">        - turbulence_valid: True where u* &gt; 0.1 and Ïv &gt; 0</span>
<span class="sd">        - rsl_valid: True where measurement height above RSL</span>
<span class="sd">        Combined validity is stored in self.valid_footprint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">validity_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>

        <span class="c1"># Height validity: 20zâ &lt; zm &lt; he</span>
        <span class="n">validity_mask</span><span class="p">[</span><span class="s2">&quot;height_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]),</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Stability validity: -15.5 â¤ zm/L</span>
        <span class="n">validity_mask</span><span class="p">[</span><span class="s2">&quot;stability_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">15.5</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Turbulence validity</span>
        <span class="n">validity_mask</span><span class="p">[</span><span class="s2">&quot;turbulence_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Combined validity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_footprint</span> <span class="o">=</span> <span class="n">validity_mask</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># Add RSL-specific checks</span>
        <span class="n">rsl_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_rsl_validity</span><span class="p">()</span>
        <span class="n">validity_mask</span><span class="p">[</span><span class="s2">&quot;rsl_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsl_valid</span>

        <span class="c1"># Update combined validity to include RSL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_footprint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_footprint</span> <span class="o">&amp;</span> <span class="n">rsl_valid</span>

        <span class="k">return</span> <span class="n">validity_mask</span></div>


<div class="viewcode-block" id="FFPModel.calc_pi_4">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_pi_4">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_pi_4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate Î 4 with comprehensive stability function implementation including neutral conditions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.DataArray</span>
<span class="sd">        Calculated Î 4 values with proper neutral condition handling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stability_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span>

        <span class="c1"># Initialize psi_m array</span>
        <span class="n">psi_m</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stability_param</span><span class="p">)</span>

        <span class="c1"># Determine stability regimes</span>
        <span class="n">stable_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">unstable_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oln</span>
        <span class="n">neutral_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oln</span><span class="p">)</span>

        <span class="c1"># Calculate psi_m for each stability regime</span>
        <span class="c1"># Stable conditions</span>
        <span class="n">psi_m</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stable_mask</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3</span> <span class="o">*</span> <span class="n">stability_param</span><span class="p">,</span> <span class="n">psi_m</span><span class="p">)</span>

        <span class="c1"># Unstable conditions</span>
        <span class="n">psi_m</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unstable_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_unstable_psi</span><span class="p">(</span><span class="n">stability_param</span><span class="p">),</span> <span class="n">psi_m</span><span class="p">)</span>

        <span class="c1"># Neutral conditions - psi_m remains zero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Stability regime counts - Stable: </span><span class="si">{</span><span class="n">stable_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Unstable: </span><span class="si">{</span><span class="n">unstable_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Neutral: </span><span class="si">{</span><span class="n">neutral_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">psi_m</span></div>


<div class="viewcode-block" id="FFPModel.calc_unstable_psi">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_unstable_psi">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_unstable_psi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stability_param</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate ÏM for unstable atmospheric conditions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stability_param : xarray.DataArray</span>
<span class="sd">            Stability parameter zm/L.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Stability correction ÏM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Limit stability parameter to prevent numerical issues</span>
        <span class="n">stability_param</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stability_param</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">15.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.5</span><span class="p">,</span> <span class="n">stability_param</span><span class="p">)</span>

        <span class="n">chi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">19</span> <span class="o">*</span> <span class="n">stability_param</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.25</span>

        <span class="c1"># Implement the full equation with better numerical handling</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">chi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">chi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">chi</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.apply_paper_smoothing">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.apply_paper_smoothing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_paper_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply 3x3 smoothing kernel from the Kljun et al. paper.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Smoothed footprint climatology.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting paper smoothing...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Define smoothing kernel</span>
            <span class="n">skernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]])</span>

            <span class="c1"># Apply convolution twice as specified in paper</span>
            <span class="n">smoothed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Track original stats</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pre-smoothing stats - Min: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, Max: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">smoothed</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve2d</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">skernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="mi">0</span>
                    <span class="p">),</span>
                    <span class="n">smoothed</span><span class="p">,</span>
                    <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]],</span>
                    <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]],</span>
                    <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;allowed&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Smoothing iteration </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> complete&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Post-iteration stats - Min: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, Max: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">smoothed</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">smoothed</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">smoothed</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Smoothing produced invalid results, reverting to unsmoothed data&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span>

            <span class="k">return</span> <span class="n">smoothed</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in smoothing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning unsmoothed data&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span></div>


<div class="viewcode-block" id="FFPModel.verify_results">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.verify_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for NaN or infinite values in the given data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : array-like or xarray.DataArray</span>
<span class="sd">            The data to verify.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            Descriptive name for logging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN values detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">notnull</span><span class="p">())):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-finite values detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN values detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-finite values detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to convert to numpy array first</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN values detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">arr</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-finite values detected in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not verify </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> for NaN/infinite values&quot;</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.verify_data">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.verify_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify the content and structure of a DataArray.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : xarray.DataArray</span>
<span class="sd">            Data array to check.</span>
<span class="sd">        name : str</span>
<span class="sd">            Variable name for logging.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if valid, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is None&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a DataArray, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All values in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> are NaN&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Log statistics for debugging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> statistics:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  NaN count: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FFPModel.calc_xr_footprint">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_xr_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_xr_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the flux footprint using xarray operations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Climatological flux footprint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting footprint calculation...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate wind direction rotation using numpy functions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rotated theta shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Calculate stability parameter and Monin-Obukhov stability function</span>
            <span class="n">psi_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_pi_4</span><span class="p">()</span>

            <span class="c1"># Initialize arrays</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Initializing arrays with shape: x=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Calculate scaled distance using numpy functions with xarray</span>
            <span class="n">xstar_ci_dummy</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="p">)</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">psi_f</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xstar_ci_dummy shape: </span><span class="si">{</span><span class="n">xstar_ci_dummy</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;xstar_ci_dummy range: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">xstar_ci_dummy</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">xstar_ci_dummy</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Calculate footprint components</span>
            <span class="n">f_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_integrated_footprint</span><span class="p">(</span><span class="n">xstar_ci_dummy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_array_stats</span><span class="p">(</span><span class="s2">&quot;crosswind_integrated_footprint&quot;</span><span class="p">,</span> <span class="n">f_ci</span><span class="p">)</span>

            <span class="c1"># Handle crosswind dispersion</span>
            <span class="n">sigy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_spread_xr</span><span class="p">(</span><span class="n">xstar_ci_dummy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_array_stats</span><span class="p">(</span><span class="s2">&quot;crosswind_dispersion&quot;</span><span class="p">,</span> <span class="n">sigy</span><span class="p">)</span>

            <span class="c1"># Calculate 2D footprint using numpy functions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">sigy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">f_ci</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigy</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_array_stats</span><span class="p">(</span><span class="s2">&quot;2d_footprint&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span><span class="p">)</span>

            <span class="c1"># Calculate footprint climatology</span>
            <span class="n">footprint_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
            <span class="n">total_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">footprint_sum</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">total_sum</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Near-zero sum in footprint climatology, initializing with uniform distribution&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">footprint_sum</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="n">footprint_sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_len</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_array_stats</span><span class="p">(</span><span class="s2">&quot;climatology&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">)</span>

            <span class="c1"># Apply smoothing if requested</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_paper_smoothing</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Footprint calculation completed successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in footprint calculation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_log_array_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log statistics for an array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Descriptive name.</span>
<span class="sd">        arr : xarray.DataArray</span>
<span class="sd">            The array to summarize.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> statistics:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Shape: </span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  NaN count: </span><span class="si">{</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FFPModel.calc_scaled_distance_rsl">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_scaled_distance_rsl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_scaled_distance_rsl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate scaled distance X* with roughness sublayer correction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Corrected scaled distance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Basic scaled distance calculation</span>
        <span class="n">xstar_base</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="p">)</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_pi_4</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># Apply RSL correction where needed</span>
        <span class="n">in_rsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z_star&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">in_rsl</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Calculate blind zone adjustment</span>
            <span class="n">x_adj</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_rsl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="c1"># Adjust scaled distance</span>
            <span class="n">xstar_adj</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_rsl</span><span class="p">,</span> <span class="n">xstar_base</span> <span class="o">+</span> <span class="n">x_adj</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">],</span> <span class="n">xstar_base</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">xstar_adj</span>

        <span class="k">return</span> <span class="n">xstar_base</span></div>


<div class="viewcode-block" id="FFPModel.calculate_pi_groups">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calculate_pi_groups">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_pi_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate dimensionless Î  groups for analysis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of xarray.DataArray</span>
<span class="sd">            Î â, Î â, Î â, Î â values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;f_2d&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;f_2d must be initialized before calculating pi groups&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Î 1 = fy*zm</span>
        <span class="n">pi_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>

        <span class="c1"># Î 2 = x/zm</span>
        <span class="n">pi_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>

        <span class="c1"># Î 3 = (h - zm)/h = 1 - zm/h</span>
        <span class="n">pi_3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span>

        <span class="c1"># Î 4 = u(zm)/(u*k) = ln(zm/z0) - ÏM</span>
        <span class="n">pi_4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_pi_4</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pi_1</span><span class="p">,</span> <span class="n">pi_2</span><span class="p">,</span> <span class="n">pi_3</span><span class="p">,</span> <span class="n">pi_4</span></div>


<div class="viewcode-block" id="FFPModel.calc_crosswind_dispersion">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_crosswind_dispersion">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_crosswind_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xstar_ci_dummy</span><span class="p">,</span> <span class="n">px</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute dimensionless crosswind dispersion with safety checks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xstar_ci_dummy : xarray.DataArray</span>
<span class="sd">            Scaled distance.</span>
<span class="sd">        px : bool</span>
<span class="sd">            Condition flag.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Dimensionless crosswind dispersion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ensure positive input for sqrt</span>
            <span class="n">x_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xstar_ci_dummy</span><span class="p">)</span>
            <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">*</span> <span class="n">x_abs</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>

            <span class="n">sqrt_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">*</span> <span class="n">x_abs</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Ensure non-negative input to sqrt</span>
                <span class="mf">1e6</span><span class="p">,</span>  <span class="c1"># Upper limit to prevent overflow</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqrt_term</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="c1"># Safety check for invalid values</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in crosswind dispersion calculation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xstar_ci_dummy</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.scale_crosswind_dispersion">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.scale_crosswind_dispersion">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale_crosswind_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigystar_dummy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale the dimensionless crosswind dispersion Ïy* to real-scale Ïy.</span>

<span class="sd">        Implements the real-scale conversion described in Equations 12-13 and surrounding text</span>
<span class="sd">        of Kljun et al. (2015):</span>

<span class="sd">        Ïy = Ïy*/(scale_const) * zm * Ïv/u*</span>

<span class="sd">        where:</span>
<span class="sd">        - Ïy* is dimensionless crosswind dispersion</span>
<span class="sd">        - scale_const is stability-dependent scaling factor:</span>
<span class="sd">            For L â¤ 0 (convective): scale_const = min(1, 10â»âµ|zm/L|â»Â¹ + 0.80)</span>
<span class="sd">            For L &gt; 0 (stable): scale_const = min(1, 10â»âµ|zm/L|â»Â¹ + 0.55)</span>
<span class="sd">        - zm is measurement height</span>
<span class="sd">        - Ïv is standard deviation of lateral velocity fluctuations</span>
<span class="sd">        - u* is friction velocity</span>

<span class="sd">        Args:</span>
<span class="sd">            sigystar_dummy (xarray.DataArray): Dimensionless crosswind dispersion Ïy*</span>

<span class="sd">        Returns:</span>
<span class="sd">            xarray.DataArray: Real-scale crosswind dispersion Ïy [m]</span>

<span class="sd">        Note:</span>
<span class="sd">            Includes numerical safety checks to prevent division by zero and handle</span>
<span class="sd">            potential non-finite values in intermediate calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting crosswind dispersion scaling...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input Ïy* shape: </span><span class="si">{</span><span class="n">sigystar_dummy</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Ïy* range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">sigystar_dummy</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">sigystar_dummy</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Calculate stability parameter</span>
            <span class="n">stability_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Stability parameter range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">stability_param</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">stability_param</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Calculate stability-dependent scaling constant with safety</span>
            <span class="n">scale_const</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stability_param</span><span class="p">),</span> <span class="mf">1e-10</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">+</span> <span class="mf">0.80</span><span class="p">,</span>  <span class="c1"># Convective</span>
                <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stability_param</span><span class="p">),</span> <span class="mf">1e-10</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">+</span> <span class="mf">0.55</span><span class="p">,</span>  <span class="c1"># Stable</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Scale constant range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">scale_const</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">scale_const</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Limit scaling constant</span>
            <span class="n">scale_const</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">scale_const</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">scale_const</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="mf">1.0</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applied upper limit of 1.0 to scale constant&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Final scale constant range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">scale_const</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">scale_const</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Calculate scaled dispersion with safety checks</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">sigystar_dummy</span>
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">scale_const</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">],</span> <span class="mf">1e-10</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">],</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Log intermediate values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;zm range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;zm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;zm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;sigmav range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigmav&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigmav&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ustar range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;ustar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;ustar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Final safety check</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Final Ïy range: [</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Crosswind dispersion scaling completed successfully&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in scaling crosswind dispersion: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detailed error trace:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FFPModel.calc_2d_footprint">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_2d_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_2d_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_ci_dummy</span><span class="p">,</span> <span class="n">sigy_dummy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the two-dimensional footprint distribution f(x,y).</span>

<span class="sd">        Implementation of Equation 10 from Kljun et al. (2015):</span>
<span class="sd">        f(x,y) = fy(x) * (1/(sqrt(2Ï)Ïy)) * exp(-y^2/(2Ïy^2))</span>

<span class="sd">        Where:</span>
<span class="sd">        - fy(x) is the crosswind-integrated footprint</span>
<span class="sd">        - Ïy is the standard deviation of crosswind spread</span>
<span class="sd">        - y is the crosswind distance from the centerline</span>

<span class="sd">        Args:</span>
<span class="sd">            f_ci_dummy: Crosswind-integrated footprint</span>
<span class="sd">            sigy_dummy: Scaled crosswind dispersion</span>

<span class="sd">        Returns:</span>
<span class="sd">            xr.DataArray: Two-dimensional footprint [m^-2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">sigy_dummy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">f_ci_dummy</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigy_dummy</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_theta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigy_dummy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.calculate_source_areas">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calculate_source_areas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_source_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute source areas for all specified relative contributions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary of contour datasets by contribution level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_areas</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Calculate for each requested relative contribution</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping r=</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">, outside valid range 0.1-0.9&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Calculate extents</span>
            <span class="n">x_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_integrated_extent</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">x_ru</span><span class="p">,</span> <span class="n">x_rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_peak_based_limits</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">y_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_extent</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x_ru</span><span class="p">,</span> <span class="n">x_rd</span><span class="p">)</span>

            <span class="c1"># Store results as xarray objects</span>
            <span class="n">source_areas</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;r_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x_r&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">x_r</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;extent&quot;</span><span class="p">),</span>
                <span class="s2">&quot;x_ru&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">x_ru</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;upwind_extent&quot;</span><span class="p">),</span>
                <span class="s2">&quot;x_rd&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">x_rd</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;downwind_extent&quot;</span><span class="p">),</span>
                <span class="s2">&quot;y_r&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">y_r</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;crosswind_extent&quot;</span><span class="p">),</span>
                <span class="s2">&quot;contour&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_area_contour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x_ru</span><span class="p">,</span> <span class="n">x_rd</span><span class="p">,</span> <span class="n">y_r</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">source_areas</span></div>


<div class="viewcode-block" id="FFPModel.calc_crosswind_integrated_extent">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_crosswind_integrated_extent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_crosswind_integrated_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate crosswind-integrated footprint extent for relative contribution r.</span>
<span class="sd">        Following Equations 23-25 of the paper.</span>

<span class="sd">        Args:</span>
<span class="sd">            r: Relative contribution (between 0.1 and 0.9)</span>

<span class="sd">        Returns:</span>
<span class="sd">            xr.DataArray: Distance from receptor containing fraction r of footprint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parameters from Eq. 17</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">1.462</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mf">0.136</span>

        <span class="c1"># Calculate scaled extent from Eq. 24</span>
        <span class="n">x_star_r</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span>

        <span class="c1"># Convert to real scale using Eq. 25</span>
        <span class="n">x_r</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">x_star_r</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_pi_4</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">x_r</span></div>


<div class="viewcode-block" id="FFPModel.calc_peak_based_limits">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_peak_based_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_peak_based_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate upwind and downwind distances from the peak location for fraction r.</span>
<span class="sd">        Following Eq. 26 of the paper.</span>

<span class="sd">        Args:</span>
<span class="sd">            r: Relative contribution (between 0.1 and 0.9)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple containing upwind and downwind distances from peak</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate peak location (Eq. 20)</span>
        <span class="n">x_star_max</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

        <span class="c1"># Get x_star_r from crosswind integration</span>
        <span class="n">x_star_r</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

        <span class="c1"># Calculate downwind limit (Eq. 26 with first set of parameters)</span>
        <span class="n">x_star_rd</span> <span class="o">=</span> <span class="mf">0.44</span> <span class="o">*</span> <span class="n">x_star_r</span><span class="o">**-</span><span class="mf">0.77</span> <span class="o">+</span> <span class="mf">0.24</span>

        <span class="c1"># New fixed condition:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_star_max</span> <span class="o">&lt;</span> <span class="n">x_star_r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_star_r</span> <span class="o">&lt;=</span> <span class="mf">1.5</span><span class="p">)</span>

        <span class="c1"># Calculate upwind limit with split conditions (Eq. 26)</span>
        <span class="n">x_star_ru</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">condition</span><span class="p">,</span>
            <span class="mf">0.60</span> <span class="o">*</span> <span class="n">x_star_r</span><span class="o">**</span><span class="mf">1.32</span> <span class="o">+</span> <span class="mf">0.61</span><span class="p">,</span>
            <span class="mf">0.96</span> <span class="o">*</span> <span class="n">x_star_r</span><span class="o">**</span><span class="mf">1.01</span> <span class="o">+</span> <span class="mf">0.19</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert to real scale</span>
        <span class="n">x_rd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_to_real_distance</span><span class="p">(</span><span class="n">x_star_rd</span><span class="p">)</span>
        <span class="n">x_ru</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_to_real_distance</span><span class="p">(</span><span class="n">x_star_ru</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_ru</span><span class="p">,</span> <span class="n">x_rd</span></div>


<div class="viewcode-block" id="FFPModel.calc_real_footprint_peak">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_real_footprint_peak">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_real_footprint_peak</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">zm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">],</span>
        <span class="n">h</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">],</span>
        <span class="n">u_zm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ustar</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">z0</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the real-scale footprint peak location.</span>
<span class="sd">        Based on Equations 20-22 of Kljun et al. (2015).</span>
<span class="sd">        Works with both scalar values and xarray DataArrays.</span>

<span class="sd">        Args:</span>
<span class="sd">            zm: Measurement height [m]</span>
<span class="sd">            h: Boundary layer height [m]</span>
<span class="sd">            u_zm: Mean wind speed at measurement height [m/s], optional</span>
<span class="sd">            ustar: Friction velocity [m/s], optional</span>
<span class="sd">            z0: Roughness length [m], optional</span>
<span class="sd">            k: von Karman constant (default=0.4)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Real distance to footprint peak [m]</span>
<span class="sd">            Returns DataArray if inputs are DataArrays, float if inputs are scalars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate scaled peak location (Eq. 20)</span>
        <span class="n">x_star_max</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># Should evaluate to 0.87</span>

        <span class="c1"># Check which conversion method to use based on available inputs</span>
        <span class="k">if</span> <span class="n">u_zm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ustar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use Eq. 21 with wind speed and friction velocity</span>
            <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_star_max</span> <span class="o">*</span> <span class="n">zm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">zm</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u_zm</span> <span class="o">/</span> <span class="p">(</span><span class="n">ustar</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">z0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use Eq. 22 with roughness length and stability correction</span>
            <span class="n">psi_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_pi_4</span><span class="p">()</span>
            <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_star_max</span> <span class="o">*</span> <span class="n">zm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">zm</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">zm</span> <span class="o">/</span> <span class="n">z0</span><span class="p">)</span> <span class="o">-</span> <span class="n">psi_m</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either (u_zm, ustar) or z0&quot;</span><span class="p">)</span>

        <span class="c1"># Log output differently for scalar vs DataArray</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Calculated footprint peak with mean at x = </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x_max</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> m&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated footprint peak at x = </span><span class="si">{</span><span class="n">x_max</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_max</span></div>


<div class="viewcode-block" id="FFPModel.calc_scaled_footprint_peak">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_scaled_footprint_peak">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_scaled_footprint_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the scaled footprint peak location (X*max).</span>
<span class="sd">        Based on Equation 20 of Kljun et al. (2015).</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Scaled distance to footprint peak (constant)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># Should evaluate to 0.87</span></div>


<div class="viewcode-block" id="FFPModel.scale_to_real_distance">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.scale_to_real_distance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale_to_real_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_star</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert scaled distance to real distance using Eq. 6/7.</span>

<span class="sd">        Args:</span>
<span class="sd">            x_star: Scaled distance X*</span>

<span class="sd">        Returns:</span>
<span class="sd">            xr.DataArray: Real-scale distance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">x_star</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;z0&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_pi_4</span><span class="p">())</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FFPModel.calc_crosswind_extent">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_crosswind_extent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_crosswind_extent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x_ru</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">x_rd</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate crosswind extent of source area using parameterized relationships.</span>

<span class="sd">        Args:</span>
<span class="sd">            r: Relative contribution</span>
<span class="sd">            x_ru: Upwind distance from peak</span>
<span class="sd">            x_rd: Downwind distance from peak</span>

<span class="sd">        Returns:</span>
<span class="sd">            xr.DataArray: Crosswind extent at each distance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate sigma_y at peak location</span>
        <span class="n">x_peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_real_footprint_peak</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;umean&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">sigma_y_peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_crosswind_spread</span><span class="p">(</span><span class="n">x_peak</span><span class="p">)</span>

        <span class="c1"># Scale crosswind extent based on distance from peak</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">scale_sigma</span><span class="p">(</span><span class="n">x_dist</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sigma_y_peak</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_dist</span> <span class="o">/</span> <span class="n">x_peak</span><span class="p">)</span>

        <span class="n">y_r</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_rd</span> <span class="o">&lt;=</span> <span class="n">x_peak</span><span class="p">,</span> <span class="n">scale_sigma</span><span class="p">(</span><span class="n">x_rd</span><span class="p">),</span> <span class="n">scale_sigma</span><span class="p">(</span><span class="n">x_ru</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">y_r</span></div>


<div class="viewcode-block" id="FFPModel.calc_crosswind_spread_xr">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_crosswind_spread_xr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_crosswind_spread_xr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_star</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the standard deviation of crosswind spread Ïy.</span>

<span class="sd">        Implements Equations 18-19 from Kljun et al. (2015):</span>
<span class="sd">        ``Ïy* = ac * sqrt((bc * |X*|^2)/(1 + cc|X*|))``</span>

<span class="sd">        Where ac=2.17, bc=1.66, cc=20.0 (Equation 19)</span>

<span class="sd">        Real-scale Ïy is then obtained through:</span>
<span class="sd">        ``Ïy = Ïy*/(scale_const) * zm * Ïv/u*``</span>

<span class="sd">        Where scale_const depends on stability (Eq. not numbered in paper):</span>
<span class="sd">        - For unstable: 1e-5|zm/L|^(-1) + 0.80</span>
<span class="sd">        - For stable: 1e-5|zm/L|^(-1) + 0.55</span>

<span class="sd">        Args:</span>
<span class="sd">            x_star (float or array): Distance from receptor [m]</span>

<span class="sd">        Returns:</span>
<span class="sd">            Standard deviation of crosswind spread [m]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate scaled crosswind spread Ïy* using Eq. 18</span>
            <span class="n">sigma_y_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">*</span> <span class="n">x_star</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">*</span> <span class="n">x_star</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">scale_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_crosswind_dispersion</span><span class="p">(</span><span class="n">sigma_y_star</span><span class="p">)</span>

            <span class="c1"># Convert to real scale</span>
            <span class="n">sigma_y</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">sigma_y_star</span>
                <span class="o">/</span> <span class="n">scale_const</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">sigma_y</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating crosswind spread: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FFPModel.calc_crosswind_spread">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.calc_crosswind_spread">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_crosswind_spread</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the standard deviation of cross-wind spread :math:`\sigma_y`.</span>

<span class="sd">        Implements Eqs. 18-19 from *Kljun et al., 2015*:</span>

<span class="sd">        .. math::</span>

<span class="sd">            \sigma_y^* = a_c \sqrt{\frac{b_c \lvert X^* \rvert^2}</span>
<span class="sd">                                        {1 + c_c \lvert X^* \rvert}}</span>

<span class="sd">            \sigma_y   = \frac{\sigma_y^*}{\text{scale\_const}}</span>
<span class="sd">                        \; z_m \; \sigma_v / u_*</span>

<span class="sd">        where</span>

<span class="sd">        * :math:`a_c = 2.17`</span>
<span class="sd">        * :math:`b_c = 1.66`</span>
<span class="sd">        * :math:`c_c = 20.0`</span>
<span class="sd">        * ``scale_const`` depends on stability (see paper).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float or ndarray</span>
<span class="sd">            Up-wind distance from the receptor [m].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or ndarray</span>
<span class="sd">            Cross-wind spread :math:`\sigma_y` [m].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get mean values of stability parameters for consistent calculation</span>
        <span class="n">zm_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">h_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">u_zm_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;umean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ustar_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ustar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">sigmav_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sigmav&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">ol_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="c1"># Calculate mean stability parameter</span>
        <span class="n">stability_param_mean</span> <span class="o">=</span> <span class="n">zm_mean</span> <span class="o">/</span> <span class="n">ol_mean</span>

        <span class="c1"># Calculate scaled distance X*</span>
        <span class="n">x_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_scaled_x</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Calculate scaled crosswind spread Ïy* using Eq. 18</span>
        <span class="c1"># Parameters from Eq. 19: ac = 2.17, bc = 1.66, cc = 20.0</span>
        <span class="n">sigma_y_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bc</span> <span class="o">*</span> <span class="n">x_star</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">*</span> <span class="n">x_star</span><span class="p">))</span>

        <span class="c1"># Calculate stability-dependent scaling constant</span>
        <span class="k">if</span> <span class="n">stability_param_mean</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Convective</span>
            <span class="n">scale_const</span> <span class="o">=</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stability_param_mean</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.80</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Stable</span>
            <span class="n">scale_const</span> <span class="o">=</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stability_param_mean</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.55</span>

        <span class="c1"># Limit scaling constant to maximum of 1.0</span>
        <span class="n">scale_const</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scale_const</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Convert to real scale (Eq. 18)</span>
        <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">sigma_y_star</span> <span class="o">/</span> <span class="n">scale_const</span> <span class="o">*</span> <span class="n">zm_mean</span> <span class="o">*</span> <span class="n">sigmav_mean</span> <span class="o">/</span> <span class="n">ustar_mean</span>

        <span class="k">return</span> <span class="n">sigma_y</span></div>


<div class="viewcode-block" id="FFPModel.plot_footprint">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.plot_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the footprint climatology with optional contours.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration object containing metadata (optional)</span>
<span class="sd">            ax: Matplotlib axis to plot on (optional)</span>
<span class="sd">            show_contours: Whether to show contour lines</span>
<span class="sd">            levels: Number of contour levels or list of levels</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib.figure.Figure, matplotlib.axes.Axes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

            <span class="c1"># Create meshgrid for plotting if needed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain shapes - x: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">, y: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Footprint climatology shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Footprint climatology stats - min: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2">, max: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Plot filled contours</span>
            <span class="n">contourf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlOrRd&quot;</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contourf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flux footprint&quot;</span><span class="p">)</span>

            <span class="c1"># Add contour lines if requested</span>
            <span class="k">if</span> <span class="n">show_contours</span><span class="p">:</span>
                <span class="n">contour</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">,</span>
                    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                    <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.1e</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Add tower location</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;k^&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Tower&quot;</span><span class="p">)</span>

            <span class="c1"># Set labels and title</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Distance [m]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Distance [m]&quot;</span><span class="p">)</span>

            <span class="c1"># Try to get site name from config if available</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Flux Footprint&quot;</span>
            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">site_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;METADATA&quot;</span><span class="p">,</span> <span class="s2">&quot;site_name&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">site_name</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Flux Footprint - </span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not get site name from config: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error plotting footprint: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="FFPModel.run">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the FFP model calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            return_result: If True, returns complete results dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[xr.Dataset]: Dataset containing footprint results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting FFP model calculations...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ensure domain is properly initialized</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">define_domain</span><span class="p">()</span>

            <span class="c1"># Initialize fclim_2d with zeros before calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># Perform main calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_xr_footprint</span><span class="p">()</span>  <span class="c1"># Now returns fclim_2d directly</span>

            <span class="c1"># Add validation checks</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;fclim_2d is None after calculations&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Footprint climatology calculation failed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;fclim_2d is not a DataArray, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid footprint climatology type&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;All values in fclim_2d are NaN&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid footprint climatology values&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain shapes - x: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">, y: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Footprint climatology shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Footprint climatology stats - min: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="si">}</span><span class="s2">, max: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create base results dataset with explicit dimensions</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;footprint_climatology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">,</span>  <span class="c1"># Use DataArray directly</span>
                            <span class="s2">&quot;domain_x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                            <span class="s2">&quot;domain_y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;f_2d&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;footprint_2d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;f_2d missing time dimension&quot;</span><span class="p">)</span>

                    <span class="c1"># Add source areas if calculated</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;source_areas&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_areas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">r_level</span><span class="p">,</span> <span class="n">area_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_areas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">area_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                                    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r_level</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FFP model calculations completed successfully&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">results</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating results dataset: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in FFP calculations: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Traceback:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Add full traceback</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FFP model calculations completed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FFPModel.save_results">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.improved_ffp.FFPModel.save_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save model results to a netCDF file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Path where the results should be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;footprint_2d&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_2d</span><span class="p">,</span>
                <span class="s2">&quot;footprint_climatology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fclim_2d</span><span class="p">,</span>
                <span class="s2">&quot;domain_x&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;domain_y&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;crop_height&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h_c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="s2">&quot;inst_height&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h_c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="s2">&quot;atm_bound_height&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">}</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Add source areas as individual variables</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;source_areas&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_areas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">results</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Paul Inkenbrandt, Natascha Kljun, John Volk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
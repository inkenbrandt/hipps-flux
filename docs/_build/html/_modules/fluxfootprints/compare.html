

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fluxfootprints.compare &mdash; fluxfootprint 0.1.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=92734c54"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            fluxfootprint
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fluxfootprints.html">fluxfootprints package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">fluxfootprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exp.html">Flux Footprints: Key Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modeltypes.html">Outline of Flux Measurement Footprint Estimation Approaches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/footprint.html">Quick-start notebook</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fluxfootprint</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fluxfootprints.compare</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fluxfootprints.compare</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;footprint_compare.py</span>
<span class="sd">========================</span>
<span class="sd">Utility functions for computing and comparing eddy‑covariance flux‑footprint</span>
<span class="sd">models.</span>

<span class="sd">The module provides a small toolkit to **re‑run the side‑by‑side evaluations**</span>
<span class="sd">we discussed earlier:</span>

<span class="sd">1. Run multiple footprint models (classic Kljun‑FFP, the xarray rewrite</span>
<span class="sd">   ``ffp_xr``\, the analytic Kormann‑Meixner (KM) approximation, or any other</span>
<span class="sd">   user‑supplied function).</span>
<span class="sd">2. Compute common diagnostic metrics against a chosen reference model</span>
<span class="sd">   (RMSE, peak‑location bias, 80 % source‑area overlap).</span>
<span class="sd">3. Return a tidy ``pandas.DataFrame`` *and* create optional difference plots.</span>

<span class="sd">All heavy lifting (meteorological inputs, domain definition …) is delegated to</span>
<span class="sd">existing model APIs; this file is purely orchestration + diagnostics.</span>

<span class="sd">Example</span>
<span class="sd">-------</span>
<span class="sd">&gt;&gt;&gt; import pandas as pd, numpy as np</span>
<span class="sd">&gt;&gt;&gt; from footprint_compare import (</span>
<span class="sd">...     run_ffp, run_ffp_xr, run_km, compare_footprints)</span>
<span class="sd">&gt;&gt;&gt; met = pd.DataFrame({  # 24 h synthetic</span>
<span class="sd">...     &quot;wind_dir&quot;: 0.0, &quot;ws&quot;: 5.0, &quot;sigmav&quot;: .5,</span>
<span class="sd">...     &quot;ustar&quot;: .3, &quot;ol&quot;: 200.0},</span>
<span class="sd">...     index=pd.date_range(&quot;2025-05-01&quot;, periods=24, freq=&quot;h&quot;))</span>
<span class="sd">&gt;&gt;&gt; dom = [-300, 300, -300, 300]</span>
<span class="sd">&gt;&gt;&gt; f_ref, (x, y) = run_ffp(met, domain=dom, dx=2)</span>
<span class="sd">&gt;&gt;&gt; f_xr,  _       = run_ffp_xr(met, domain=dom, dx=2)</span>
<span class="sd">&gt;&gt;&gt; res = compare_footprints(f_ref, (x, y),</span>
<span class="sd">...                          {&quot;FFP_xr&quot;: (f_xr, (x, y))})</span>
<span class="sd">&gt;&gt;&gt; print(res)</span>

<span class="sd">Dependencies</span>
<span class="sd">------------</span>
<span class="sd">``numpy, pandas, matplotlib, scipy``;</span>
<span class="sd">footprint models: ``calc_footprint_FFP_climatology``, ``ffp_xr`` (these must be</span>
<span class="sd">importable, e.g. placed on ``PYTHONPATH``).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegularGridInterpolator</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Helper metrics</span>
<span class="c1"># -----------------------------------------------------------------------------</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_peak_distance</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the Euclidean distance from the origin to the peak of a footprint.</span>

<span class="sd">    Identifies the location of the maximum value in the footprint array `f`</span>
<span class="sd">    and calculates its distance from the origin (assumed tower location at (0, 0))</span>
<span class="sd">    using the provided coordinate grids.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : numpy.ndarray</span>
<span class="sd">        2D footprint array with source strength values.</span>
<span class="sd">    x : numpy.ndarray</span>
<span class="sd">        2D array of x-coordinate values corresponding to `f`.</span>
<span class="sd">    y : numpy.ndarray</span>
<span class="sd">        2D array of y-coordinate values corresponding to `f`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    distance : float</span>
<span class="sd">        Euclidean distance from the origin to the peak footprint location [m].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_mask_80</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a boolean mask for the 80% cumulative contribution area of a footprint.</span>

<span class="sd">    Identifies the cells in the footprint array `f` that together contribute</span>
<span class="sd">    to 80% of the total flux source area by cumulative sum of values sorted</span>
<span class="sd">    in descending order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : numpy.ndarray</span>
<span class="sd">        2D footprint array representing flux contributions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mask : numpy.ndarray</span>
<span class="sd">        Boolean array of the same shape as `f`, where `True` indicates cells</span>
<span class="sd">        that belong to the 80% cumulative source area.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">flat</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">flat</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">flat</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">])</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">flat</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumsum</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">flat</span><span class="o">.</span><span class="n">sum</span><span class="p">())]</span>
    <span class="k">return</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">thresh</span>


<div class="viewcode-block" id="footprint_metrics">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.compare.footprint_metrics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">footprint_metrics</span><span class="p">(</span>
    <span class="n">f_ref</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">x_ref</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_ref</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">f_other</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">x_other</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_other</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute diagnostic comparison metrics between two footprint distributions.</span>

<span class="sd">    Compares a test footprint (`f_other`) against a reference footprint (`f_ref`)</span>
<span class="sd">    using several spatial metrics: root mean squared error (RMSE), peak location difference,</span>
<span class="sd">    and percentage overlap of the 80% contribution area.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f_ref : numpy.ndarray</span>
<span class="sd">        Reference footprint values on a 2D grid.</span>
<span class="sd">    x_ref : numpy.ndarray</span>
<span class="sd">        X-coordinates for the reference footprint grid.</span>
<span class="sd">    y_ref : numpy.ndarray</span>
<span class="sd">        Y-coordinates for the reference footprint grid.</span>
<span class="sd">    f_other : numpy.ndarray</span>
<span class="sd">        Footprint values from the model being compared.</span>
<span class="sd">    x_other : numpy.ndarray</span>
<span class="sd">        X-coordinates for the comparison footprint grid.</span>
<span class="sd">    y_other : numpy.ndarray</span>
<span class="sd">        Y-coordinates for the comparison footprint grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metrics : dict of str to float</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">        - &#39;RMSE&#39; : Root mean squared error between footprints.</span>
<span class="sd">        - &#39;Peak_ref&#39; : Distance of the peak location in the reference footprint from the origin [m].</span>
<span class="sd">        - &#39;Peak_other&#39; : Distance of the peak location in the comparison footprint from the origin [m].</span>
<span class="sd">        - &#39;Peak_diff&#39; : Absolute difference in peak distances [m].</span>
<span class="sd">        - &#39;Overlap80(%)&#39; : Percent overlap of 80% contribution regions [%].</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the input grids are not congruent in shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">f_ref</span><span class="o">.</span><span class="n">shape</span>
        <span class="o">==</span> <span class="n">f_other</span><span class="o">.</span><span class="n">shape</span>
        <span class="o">==</span> <span class="n">x_ref</span><span class="o">.</span><span class="n">shape</span>
        <span class="o">==</span> <span class="n">y_ref</span><span class="o">.</span><span class="n">shape</span>
        <span class="o">==</span> <span class="n">x_other</span><span class="o">.</span><span class="n">shape</span>
        <span class="o">==</span> <span class="n">y_other</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Grids must be congruent. Ensure models use identical x/y domain.&quot;</span>
        <span class="p">)</span>

    <span class="n">rmse</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">f_other</span> <span class="o">-</span> <span class="n">f_ref</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="n">peak_ref</span> <span class="o">=</span> <span class="n">_peak_distance</span><span class="p">(</span><span class="n">f_ref</span><span class="p">,</span> <span class="n">x_ref</span><span class="p">,</span> <span class="n">y_ref</span><span class="p">)</span>
    <span class="n">peak_other</span> <span class="o">=</span> <span class="n">_peak_distance</span><span class="p">(</span><span class="n">f_other</span><span class="p">,</span> <span class="n">x_other</span><span class="p">,</span> <span class="n">y_other</span><span class="p">)</span>
    <span class="n">peak_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peak_other</span> <span class="o">-</span> <span class="n">peak_ref</span><span class="p">)</span>

    <span class="n">mask_ref</span> <span class="o">=</span> <span class="n">_mask_80</span><span class="p">(</span><span class="n">f_ref</span><span class="p">)</span>
    <span class="n">mask_other</span> <span class="o">=</span> <span class="n">_mask_80</span><span class="p">(</span><span class="n">f_other</span><span class="p">)</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">mask_ref</span> <span class="o">&amp;</span> <span class="n">mask_other</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">mask_ref</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
        <span class="s2">&quot;Peak_ref&quot;</span><span class="p">:</span> <span class="n">peak_ref</span><span class="p">,</span>
        <span class="s2">&quot;Peak_other&quot;</span><span class="p">:</span> <span class="n">peak_other</span><span class="p">,</span>
        <span class="s2">&quot;Peak_diff&quot;</span><span class="p">:</span> <span class="n">peak_diff</span><span class="p">,</span>
        <span class="s2">&quot;Overlap80(%)&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">,</span>
    <span class="p">}</span></div>



<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Wrappers to *run* individual models</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="c1"># Classic FFP (Kljun 2015) -----------------------------------------------------</span>


<div class="viewcode-block" id="run_ffp">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.compare.run_ffp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_ffp</span><span class="p">(</span>
    <span class="n">met</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">zm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">z0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2000.0</span><span class="p">,</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the footprint climatology using the classic FFP implementation.</span>

<span class="sd">    This function runs the `FFP_climatology` model from the</span>
<span class="sd">    `calc_footprint_FFP_climatology` module, generating a 2D footprint</span>
<span class="sd">    and corresponding spatial grid arrays based on provided meteorological inputs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    met : pandas.DataFrame</span>
<span class="sd">        DataFrame containing time series of meteorological variables.</span>
<span class="sd">        Expected columns include:</span>
<span class="sd">        - &#39;ol&#39; : Obukhov length [m]</span>
<span class="sd">        - &#39;sigmav&#39; : Standard deviation of lateral velocity [m/s]</span>
<span class="sd">        - &#39;ustar&#39; : Friction velocity [m/s]</span>
<span class="sd">        - &#39;wind_dir&#39; : Wind direction [degrees]</span>
<span class="sd">    zm : float, optional</span>
<span class="sd">        Measurement height above displacement height [m]. Default is 2.0.</span>
<span class="sd">    z0 : float, optional</span>
<span class="sd">        Surface roughness length [m]. Default is 0.1.</span>
<span class="sd">    h : float, optional</span>
<span class="sd">        Boundary layer height [m]. Default is 2000.0.</span>
<span class="sd">    domain : list of float or tuple of float, optional</span>
<span class="sd">        Spatial extent of the footprint domain in the format</span>
<span class="sd">        (xmin, xmax, ymin, ymax). Default is (-300, 300, -300, 300).</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        Grid resolution in both x and y directions [m]. Default is 2.0.</span>
<span class="sd">    **extra_kwargs</span>
<span class="sd">        Additional keyword arguments passed to `FFP_climatology`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ffp_2d : numpy.ndarray</span>
<span class="sd">        2D array of footprint climatology values.</span>
<span class="sd">    (x, y) : tuple of numpy.ndarray</span>
<span class="sd">        Tuple of 2D coordinate arrays for the x and y spatial grid [m].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">.volk</span><span class="w"> </span><span class="kn">import</span> <span class="n">ffp_climatology</span> <span class="k">as</span> <span class="n">_FFP</span>

    <span class="n">ts_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">met</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">_FFP</span><span class="p">(</span>
        <span class="n">zm</span><span class="o">=</span><span class="p">[</span><span class="n">zm</span><span class="p">]</span> <span class="o">*</span> <span class="n">ts_len</span><span class="p">,</span>
        <span class="n">z0</span><span class="o">=</span><span class="p">[</span><span class="n">z0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ts_len</span><span class="p">,</span>
        <span class="n">umean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">h</span><span class="o">=</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">*</span> <span class="n">ts_len</span><span class="p">,</span>
        <span class="n">ol</span><span class="o">=</span><span class="n">met</span><span class="p">[</span><span class="s2">&quot;ol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;ol&quot;</span> <span class="ow">in</span> <span class="n">met</span> <span class="k">else</span> <span class="p">[</span><span class="mf">200.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ts_len</span><span class="p">,</span>
        <span class="n">sigmav</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sigmav&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">ustar</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ustar&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">wind_dir</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">domain</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">domain</span><span class="p">),</span>
        <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
        <span class="n">dy</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
        <span class="n">smooth_data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;fclim_2d&quot;</span><span class="p">]),</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;x_2d&quot;</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;y_2d&quot;</span><span class="p">]),</span>
    <span class="p">)</span></div>



<span class="c1"># xarray rewrite (ffp_xr.py) ---------------------------------------------------</span>


<div class="viewcode-block" id="run_ffp_xr">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.compare.run_ffp_xr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_ffp_xr</span><span class="p">(</span>
    <span class="n">met</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the footprint climatology using the xarray-based FFP implementation.</span>

<span class="sd">    This function runs the `ffp_climatology_new` model from the `ffp_xr` module</span>
<span class="sd">    on a meteorological input DataFrame, returning the 2D footprint</span>
<span class="sd">    and associated spatial grid coordinates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    met : pandas.DataFrame</span>
<span class="sd">        DataFrame containing meteorological inputs for footprint modeling.</span>
<span class="sd">    domain : list of float or tuple of float, optional</span>
<span class="sd">        Spatial extent of the footprint domain in the format</span>
<span class="sd">        (xmin, xmax, ymin, ymax). Default is (-300, 300, -300, 300).</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        Grid resolution in both x and y directions. Default is 2.0.</span>
<span class="sd">    logger : logging.Logger or None, optional</span>
<span class="sd">        Logger instance for model output. If None, a default logger is created.</span>
<span class="sd">    **extra_kwargs</span>
<span class="sd">        Additional keyword arguments passed to `ffp_climatology_new`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ffp_2d : numpy.ndarray</span>
<span class="sd">        2D array representing the climatological footprint values.</span>
<span class="sd">    (x, y) : tuple of numpy.ndarray</span>
<span class="sd">        Tuple of arrays representing the x and y coordinates of the footprint grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">ffp_xr</span><span class="w"> </span><span class="kn">import</span> <span class="n">ffp_climatology_new</span> <span class="k">as</span> <span class="n">_FFPXR</span>

    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ffp_xr&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">_FFPXR</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">met</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">domain</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">domain</span><span class="p">),</span>
        <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
        <span class="n">dy</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
        <span class="n">smooth_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">calc_xr_footprint</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">fclim_2d</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">xv</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">yv</span><span class="p">)</span></div>



<span class="c1"># Analytic KM (Kormann &amp; Meixner) --------------------------------------------</span>


<div class="viewcode-block" id="run_km">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.compare.run_km">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_km</span><span class="p">(</span>
    <span class="n">met</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">zm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">z0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a toy 2D footprint based on a Kormann–Meixner-style analytic solution.</span>

<span class="sd">    This simplified implementation models the footprint as a product of a</span>
<span class="sd">    1D Gamma distribution in the along-wind (y) direction and a Gaussian in the</span>
<span class="sd">    cross-wind (x) direction. It is intended as a minimal, conceptual reference.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    met : pandas.DataFrame</span>
<span class="sd">        Meteorological input data (unused in this implementation, but included for API compatibility).</span>
<span class="sd">    zm : float, optional</span>
<span class="sd">        Measurement height above displacement height [m]. Default is 2.0.</span>
<span class="sd">    z0 : float, optional</span>
<span class="sd">        Surface roughness length [m]. Default is 0.1.</span>
<span class="sd">    domain : list of float or tuple of float, optional</span>
<span class="sd">        Spatial extent of the footprint domain in the format</span>
<span class="sd">        (xmin, xmax, ymin, ymax). Default is (-300, 300, -300, 300).</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        Grid resolution in both x and y directions [m]. Default is 2.0.</span>
<span class="sd">    **extra_kwargs</span>
<span class="sd">        Ignored in this implementation. Included for API consistency.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    f2d : numpy.ndarray</span>
<span class="sd">        2D array of normalized footprint values.</span>
<span class="sd">    (xv, yv) : tuple of numpy.ndarray</span>
<span class="sd">        Tuple of 2D arrays representing the x and y coordinates of the grid [m].</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The analytic form is loosely inspired by Kormann &amp; Meixner (2001) under neutral conditions.</span>
<span class="sd">    - Not intended for production use; serves as a placeholder or toy model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build grid</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">domain</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Parameters (roughly tuned to mimic FFP peak)</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span>  <span class="c1"># power‑law exponents for u, K (neutral)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="n">n</span>
    <span class="n">U</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># non‑dimensional wind speed</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">U</span> <span class="o">*</span> <span class="n">zm</span><span class="o">**</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">z0</span><span class="o">**</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># Cross‑wind Gaussian std ~  σ = a * |x|</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.35</span>

    <span class="n">fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span> <span class="o">**</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">))</span>
    <span class="n">fy</span> <span class="o">=</span> <span class="n">fy</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yv</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">m</span> <span class="o">/</span> <span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yv</span><span class="p">))</span>

    <span class="n">cross</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yv</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
        <span class="o">-</span><span class="p">(</span><span class="n">xv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">yv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">f2d</span> <span class="o">=</span> <span class="n">fy</span> <span class="o">*</span> <span class="n">cross</span>
    <span class="n">f2d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f2d</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">f2d</span> <span class="o">/=</span> <span class="n">f2d</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># normalize</span>
    <span class="k">return</span> <span class="n">f2d</span><span class="p">,</span> <span class="p">(</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">)</span></div>



<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># High‑level comparison utilities</span>
<span class="c1"># -----------------------------------------------------------------------------</span>


<div class="viewcode-block" id="compare_footprints">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.compare.compare_footprints">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_footprints</span><span class="p">(</span>
    <span class="n">ref_f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">ref_grid</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">others</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu&quot;</span><span class="p">,</span>
    <span class="n">vlim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute metrics for *others* against reference; optionally plot diffs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_f / ref_grid</span>
<span class="sd">        Reference footprint density and its (x_2d, y_2d) grids.</span>
<span class="sd">    others</span>
<span class="sd">        Dict mapping *name* → (f_2d, (x_2d, y_2d)).</span>
<span class="sd">    plot</span>
<span class="sd">        If True, draw a difference map for each entry.</span>
<span class="sd">    vlim</span>
<span class="sd">        Symmetric colour‑bar limit for difference plots.  By default the max</span>
<span class="sd">        absolute difference across all models is used.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``pandas.DataFrame`` with rows = model names, columns = metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_ref</span><span class="p">,</span> <span class="n">y_ref</span> <span class="o">=</span> <span class="n">ref_grid</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">nrow</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">others</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">footprint_metrics</span><span class="p">(</span><span class="n">ref_f</span><span class="p">,</span> <span class="n">x_ref</span><span class="p">,</span> <span class="n">y_ref</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">records</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">ref_f</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">vlim</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
            <span class="n">pcm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> – ref&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Δ density&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Convenience: run *all* models on same met‑data &amp; compare in one call</span>
<span class="c1"># -----------------------------------------------------------------------------</span>


<div class="viewcode-block" id="run_all_and_compare">
<a class="viewcode-back" href="../../fluxfootprints.html#fluxfootprints.compare.run_all_and_compare">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_all_and_compare</span><span class="p">(</span>
    <span class="n">met</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
    <span class="n">dx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">zm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">z0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2000.0</span><span class="p">,</span>
    <span class="n">include_km</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_xr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_volk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># placeholder for future</span>
    <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run multiple footprint models and compare their outputs to a reference.</span>

<span class="sd">    Executes several footprint models (FFP, FFP_xr, and optionally KM and Volk)</span>
<span class="sd">    using a common meteorological dataset and spatial domain. Each model&#39;s output</span>
<span class="sd">    is compared to the FFP reference using RMSE, peak distance, and 80% overlap metrics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    met : pandas.DataFrame</span>
<span class="sd">        DataFrame containing meteorological inputs, expected to include:</span>
<span class="sd">        - &#39;ol&#39; : Obukhov length [m]</span>
<span class="sd">        - &#39;sigmav&#39; : Lateral standard deviation of velocity [m/s]</span>
<span class="sd">        - &#39;ustar&#39; : Friction velocity [m/s]</span>
<span class="sd">        - &#39;wind_dir&#39; : Wind direction [degrees]</span>
<span class="sd">    domain : tuple of float, optional</span>
<span class="sd">        Spatial extent of the footprint domain (xmin, xmax, ymin, ymax). Default is (-300, 300, -300, 300).</span>
<span class="sd">    dx : float, optional</span>
<span class="sd">        Grid resolution in meters. Default is 2.0.</span>
<span class="sd">    zm : float, optional</span>
<span class="sd">        Measurement height [m]. Default is 2.0.</span>
<span class="sd">    z0 : float, optional</span>
<span class="sd">        Surface roughness length [m]. Default is 0.1.</span>
<span class="sd">    h : float, optional</span>
<span class="sd">        Boundary layer height [m]. Default is 2000.0.</span>
<span class="sd">    include_km : bool, optional</span>
<span class="sd">        Whether to include the KM toy model in the comparison. Default is True.</span>
<span class="sd">    include_xr : bool, optional</span>
<span class="sd">        Whether to include the `ffp_xr` model in the comparison. Default is True.</span>
<span class="sd">    include_volk : bool, optional</span>
<span class="sd">        Whether to include a Volk-style model (placeholder). Default is False.</span>
<span class="sd">    **extra_kwargs</span>
<span class="sd">        Additional arguments passed to `run_ffp`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_metrics : pandas.DataFrame</span>
<span class="sd">        DataFrame of comparison metrics (RMSE, peak location, 80% overlap)</span>
<span class="sd">        for each alternative model relative to the FFP reference.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The &quot;Volk&quot; model is not implemented and is only a placeholder.</span>
<span class="sd">    - The function generates a comparison plot using `compare_footprints(plot=True)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ref_f</span><span class="p">,</span> <span class="n">ref_grid</span> <span class="o">=</span> <span class="n">run_ffp</span><span class="p">(</span>
        <span class="n">met</span><span class="p">,</span> <span class="n">zm</span><span class="o">=</span><span class="n">zm</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_kwargs</span>
    <span class="p">)</span>

    <span class="n">others</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">include_xr</span><span class="p">:</span>
        <span class="n">f_xr</span><span class="p">,</span> <span class="n">grid_xr</span> <span class="o">=</span> <span class="n">run_ffp_xr</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">others</span><span class="p">[</span><span class="s2">&quot;FFP_xr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_xr</span><span class="p">,</span> <span class="n">grid_xr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_km</span><span class="p">:</span>
        <span class="n">f_km</span><span class="p">,</span> <span class="n">grid_km</span> <span class="o">=</span> <span class="n">run_km</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">zm</span><span class="o">=</span><span class="n">zm</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
        <span class="n">others</span><span class="p">[</span><span class="s2">&quot;KM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_km</span><span class="p">,</span> <span class="n">grid_km</span><span class="p">)</span>

    <span class="c1"># A slot for volk.py footprint (if user has a simplified wrapper)</span>
    <span class="k">if</span> <span class="n">include_volk</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">volk</span><span class="w"> </span><span class="kn">import</span> <span class="n">some_wrapper_function</span>  <span class="c1"># fictitious placeholder</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;volk.py not available – skipping&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_v</span><span class="p">,</span> <span class="n">grid_v</span> <span class="o">=</span> <span class="n">some_wrapper_function</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
            <span class="n">others</span><span class="p">[</span><span class="s2">&quot;Volk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_v</span><span class="p">,</span> <span class="n">grid_v</span><span class="p">)</span>

    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">compare_footprints</span><span class="p">(</span><span class="n">ref_f</span><span class="p">,</span> <span class="n">ref_grid</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_metrics</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Paul Inkenbrandt, Natascha Kljun, John Volk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>